<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="..\..\bower_components/polymer/polymer.html">
<link rel="import" href="..\..\bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="..\..\bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="..\..\bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="..\..\bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="..\..\bower_components/paper-button/paper-button.html">
<link rel="import" href="..\..\bower_components/iron-flex-layout/iron-flex-layout.html">

<dom-module id="tweet-list">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        display: block;
      }
      
      my-tweet {
        margin: 15px;
        transition: all 150ms ease-in-out;
      }
      
      paper-radio-button {
        --paper-radio-button-checked-color: #ccc;
        --paper-radio-button-unchecked-color: #ccc;
        --paper-radio-button-label-color: #ccc;
      }
      
      paper-fab {
        margin-bottom: 10px;
      }
      
      #irrelevant {
        background: rgba(255, 255, 255, 0.5);
        color: #333;
      }
      
      #angry {
        background: rgba(255, 0, 0, 0.5);
      }
      
      #neutral {
        background: rgba(0, 0, 255, 0.5);
      }
      
      #positive {
        background: rgba(0, 255, 0, 0.5);
      }
      
      paper-progress {
        width: 100%;
        height: 3px;
        position: absolute;
        left: 0;
        right: 0;
      }
      
      paper-toolbar.bottom {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 0px;
      }
      
      paper-toolbar::shadow #topBar {
        padding: 0px;
      }

      .predicted {
        font-weight: bold;
        text-decoration: underline;
      }

      .carousel {
        /*height: 400px;*/
        width: 100%;
      }
      
      div::shadow .carousel-cell {
        width: 40%;
        height: 500px;
      }
    </style>
<div class="layout vertical center">
  <span style="width: 25%; margin: 10px;">
        <span hidden$="{{tweet.output}}" class="layout horizontal around-justified">
          <span class="layout vertical center">
            <paper-fab title="Irrelevant" icon="delete" id="irrelevant" on-tap="classify" raised></paper-fab>
            <span class$="{{isIrrelevant(output)}}">Irrelevant</span>
  </span>
  <span class="layout vertical center">
            <paper-fab title="Angry" icon="thumb_down" id="angry" on-tap="classify" raised></paper-fab>
            <span class$="{{isAngry(output)}}">Angry</span>
  </span>
  <span class="layout vertical center">
            <paper-fab title="Neutral" icon="thumbs_up_down" id="neutral" on-tap="classify" raised></paper-fab>
            <span class$="{{isNeutral(output)}}">Neutral</span>
  </span>
  <span class="layout vertical center">
            <paper-fab title="Positive" icon="thumb_up" id="positive" on-tap="classify" raised></paper-fab>
            <span class$="{{isPositive(output)}}">Positive</span>
  </span>
  </span>
  </span>

  <div id="carousel" class="carousel">
  </div>
  <paper-toolbar class="bottom" justify="end">
    <div style="width:100%; height 3px; position: absolute">
      <template id="progress" is="dom-if" if="{{training}}">
            <paper-progress indeterminate></paper-progress>
          </template>
  </div>
  <span style="margin-left:16px">{{statusMessage}}</span>
  <span class="flex"></span>
  <span style="color:#ccc">API Mode:</span>
  <paper-radio-group disabled$="{{training}}" selected="{{apiMode}}">
    <paper-radio-button name="learn">Learn</paper-radio-button>
    <paper-radio-button name="predict">Predict</paper-radio-button>
  </paper-radio-group>
  <paper-button raised disabled$="{{training}}" style="background:#0c0; margin-right:16px" on-tap="train">Train</paper-button>
  <paper-button raised style="background:#0c0; margin-right:16px" on-tap="movenext">next</paper-button>
  <paper-button raised style="background:#0c0; margin-right:16px" on-tap="add">add</paper-button>
  </paper-toolbar>
  </div>
  </template>
  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'tweet-list',

        properties: {
          tweets: {
            type: Array,
            value: function() {
              return [];
            }
          },
          tweetCache: Array,
          apiMode: {
            type: String,
            value: 'learn',
            observer: '_changeApiMode'
          },
          output: {
            type: Object,
            notify: true
          },
          flickity: Object,
          training: Boolean,
          statusMessage: String,
          receiving: {
            type: Boolean,
            value: false
          }
        },

        isAngry: function(val) {
          return val === "angry" ? "predicted" : "";
        },
        isNeutral: function(val) {
          return val === "neutral" ? "predicted" : "";
        },
        isPositive: function(val) {
          return val === "positive" ? "predicted" : "";
        },
        isIrrelevant: function(val) {
          return val === "irrelevant" ? "predicted" : "";
        },

        listeners: {
          'hidden': '_hidden',
          'loaded': '_loaded'
        },

        makeTweetElement: function(tweet) {
          if (!tweet) {
            return;
          }

          console.log('adding tweet', tweet.tweet.id_str);

          let newTweet = document.createElement("my-tweet");
          newTweet.className += "carousel-cell";
          newTweet.setAttribute("id", "tweet" + tweet.tweet.id_str);
          newTweet.tweet = tweet.tweet;
          this.output = tweet.output;

          return newTweet;
        },

        resize: function() {
          this.flickity.resize();
        },

        showTweet: function(tweet, withDispose) {
          //  create the empty element
          var currentCell = this.flickity.selectedCell;
          let tweetCell = this.makeTweetElement(tweet);

          this.flickity.append(tweetCell);
          this.resize();

          tweetCell
            .fetchTweetAsync(tweet.tweet.id_str)
            .then((result) => {
              console.log('tweet loaded', result);
              tweetCell.loading = false;
              if (!result.tweetFrame) {
                console.log('bad tweet', tweet.tweet.id_str);
                app.socket.emit('badTweet', tweet.tweet.id_str);
                this.movenext(tweet.tweet.id_str);
                this.flickity.remove(tweetCell);
                return;
              }

              if (withDispose) {
                this.flickity.next();

                //  old cell can be disposed of now
                if (currentCell) {
                  currentCell.element.hideAnimation();
                }
              }
            });
        },

        movenext: function(currentTweetId) {
          //  get a new tweet
          app.socket.emit("tweetRequest", currentTweetId, (tweet) => {
            console.log('tweet request fulfilled', tweet.id_str);
            this.showTweet(tweet, true);
          });
        },

        add: function() {
          app.socket.emit("tweetRequest", null, (tweet) => {
            console.log('tweet request fulfilled', tweet);
            this.showTweet(tweet);
          });
        },

        classify: function(e) {
          let tweet = this.flickity.selectedCell;
          if (!tweet) {
            return;
          }
          let tweetId = tweet.element.tweet.id_str;
          //  use e.currentTarget rather than e.target or we'll sometimes get the icon rather than the button
          console.log('classifying', tweetId, 'as', e.currentTarget.id);

          app.socket.emit("classify", {
            tweetId: tweetId,
            class: e.currentTarget.id
          }, (nextTweet) => {
            this.showTweet(nextTweet, true);
          });
        },

        ready: function() {
          this.$.carousel.style.height = "500px";

          this.flickity = new Flickity(this.$.carousel, {
            useSetGallerySize: false,
            cellSelector: ".carousel-cell",
            pageDots: true
          });

          app.socket.on("tweet", (tweet) => {
            this.showTweet(tweet, false);
          });

          app.socket.on("trainingStatus", (status) => {
            this.training = status.status === "RUNNING";
            this.statusMessage = status.message;
          });

          // this.movenext();
        },

        train: function() {
          app.socket.emit("train");
        },

        _hidden: function(e) {
          let tweetElementId = "#tweet" + e.detail.tweetId;
          let hiddenTweet = this.$$(tweetElementId);
          console.log('hidden, attempting to remove', tweetElementId, hiddenTweet);
          this.flickity.remove(hiddenTweet);
          this.resize();
        },

        _loaded: function(e) {
          console.log("loaded", e.detail)
          let tweet = this.flickity.selectedElement;

          if (this.flickity.cells.length > 1) {
            this.flickity.cells[0].element.hideAnimation();
          }

          this.resize();
        },

        _changeApiMode: function(newMode) {
          app.socket.emit("apiMode", newMode);
          for (var index = 0; index < this.tweets.length; index++) {
            this.flickity.remove(this.$$("#carousel" + this.tweets[index].id_str));
          }

          this.tweets = [];

          if (newMode == "learn") {
            // app.socket.emit("tweetList", (response) => {
            //   this.tweetCache = response;

            //   this.addTweet(this.tweetCache.pop());
            // });
          }
        }
      });
    })();
  </script>
</dom-module>