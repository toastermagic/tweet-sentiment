<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="..\..\bower_components/polymer/polymer.html">
<link rel="import" href="..\..\bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="..\..\bower_components/paper-radio-button/paper-radio-button.html">
<link rel="import" href="..\..\bower_components/paper-header-panel/paper-header-panel.html">
<link rel="import" href="..\..\bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="..\..\bower_components/paper-button/paper-button.html">
<link rel="import" href="..\..\bower_components/iron-flex-layout/iron-flex-layout.html">

<dom-module id="tweet-list">
  <template>
    <style include="iron-flex iron-flex-alignment">
      :host {
        display: block;
      }
      
      .hovered {
        z-index: 500;
      }

      paper-radio-button {
        --paper-radio-button-checked-color: #ccc;
        --paper-radio-button-unchecked-color: #ccc;
        --paper-radio-button-label-color: #ccc;
      }
      
      paper-fab {
        margin-bottom: 10px;
      }
      
      #irrelevant {
        background: rgba(255, 255, 255, 0.5);
        color: #333;
      }
      
      #angry {
        background: rgba(255, 0, 0, 0.5);
      }
      
      #neutral {
        background: rgba(0, 0, 255, 0.5);
      }
      
      #positive {
        background: rgba(0, 255, 0, 0.5);
      }
      
      paper-progress {
        width: 100%;
        height: 3px;
        position: absolute;
        left: 0;
        right: 0;
      }
      
      paper-toolbar.bottom {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        padding: 0px;
      }
      
      paper-toolbar::shadow #topBar {
        padding: 0px;
      }
      
      .predicted {
        font-weight: bold;
        text-decoration: underline;
      }
    </style>
    <div class="layout vertical center">
      <div class="flex" style="width:100%">
        <div id="tweetStack" style="width:100%; height:100%; border: 1px solid black">
        </div>
      </div>
      <paper-toolbar class="bottom" justify="end">
        <div style="width:100%; height 3px; position: absolute">
          <template id="progress" is="dom-if" if="{{training}}">
            <paper-progress indeterminate></paper-progress>
          </template>
        </div>
        <span style="margin-left:16px">{{statusMessage}}</span>
        <span class="flex"></span>
        <span style="color:#ccc">API Mode:</span>
        <paper-radio-group disabled$="{{training}}" selected="{{apiMode}}">
          <paper-radio-button name="learn">Learn</paper-radio-button>
          <paper-radio-button name="predict">Predict</paper-radio-button>
        </paper-radio-group>
        <paper-button raised disabled$="{{training}}" style="background:#0c0; margin-right:16px" on-tap="train">Train</paper-button>
        <paper-button raised style="background:#0c0; margin-right:16px" on-tap="movenext">next</paper-button>
        <paper-button raised style="background:#0c0; margin-right:16px" on-tap="add">add</paper-button>
      </paper-toolbar>
    </div>
  </template>
  <script>
    (function() {
      'use strict';

      Polymer({
        is: 'tweet-list',

        properties: {
          tweets: {
            type: Array,
            value: function() {
              return [];
            }
          },
          apiMode: {
            type: String,
            value: 'learn',
            observer: '_changeApiMode'
          },
          output: {
            type: Object,
            notify: true
          },
          packery: Object,
          training: Boolean,
          statusMessage: String,
          tweetSubscription: Object
        },

        isAngry: function(val) {
          return val === "angry" ? "predicted" : "";
        },
        isNeutral: function(val) {
          return val === "neutral" ? "predicted" : "";
        },
        isPositive: function(val) {
          return val === "positive" ? "predicted" : "";
        },
        isIrrelevant: function(val) {
          return val === "irrelevant" ? "predicted" : "";
        },

        listeners: {
          'hidden': '_hidden',
          'loaded': '_loaded',
          'hovered': '_hovered',
          'unHovered': '_unHovered'
        },

        _hovered: function(e) {
          e.target.style.zIndex = 500;
        },

        _unHovered: function(e) {
          e.target.style.zIndex = e.target.zIndex;
        },

        makeTweetElement: function(tweet) {
          if (!tweet) {
            return;
          }

          console.log('adding tweet', tweet.tweet.id_str);

          let newTweet = document.createElement("my-tweet");
          newTweet.className += "grid-cell";
          newTweet.setAttribute("id", "tweet" + tweet.tweet.id_str);
          newTweet.tweet = tweet.tweet;
          newTweet.output = tweet.output;
          newTweet.style.zIndex = tweet.zIndex;
          return newTweet;
        },

        showTweet: function(tweet, withDispose) {
          //  create the empty element
          let tweetCell = this.makeTweetElement(tweet);

          this.$.tweetStack.appendChild(tweetCell);
          this.packery.appended(tweetCell);
          this.packery.layout();
          this.packery.reloadItems();

          tweetCell
            .fetchTweetAsync(tweet.tweet.id_str)
            .then((result) => {
              console.log('tweet loaded', result);
              if (!result.tweetFrame) {
                console.log('bad tweet', tweet.tweet.id_str);
                mySocket.sendCommand("badTweet", tweet.tweet.id_str);
                this.movenext(tweet.tweet.id_str);
                return;
              }

              if (withDispose) {
                //  old cell can be disposed of now
              }
            });
        },

        movenext: function(currentTweetId) {
          //  get a new tweet
          mySocket
            .requestTweets(currentTweetId, 1)
            .take(1)
            .subscribe((tweet) => {
              this.showTweet(tweet, true);
            });
        },

        add: function() {
          //  get a new tweet
          mySocket
            .requestTweets(null, 1)
            .take(1)
            .subscribe((tweet) => {
              this.showTweet(tweet);
            });
        },

        classify: function(e) {
          if (!tweet) {
            return;
          }
          let tweetId = tweet.element.tweet.id_str;
          //  use e.currentTarget rather than e.target or we'll sometimes get the icon rather than the button
          console.log('classifying', tweetId, 'as', e.currentTarget.id);
          mySocket.classifyTweet(tweetId, e.currentTarget.id);
        },

        ready: function() {
          var elem = this.$.tweetStack;
          this.packery = new Packery(elem, {
            itemSelector: '.grid-cell',
            gutter: 10
          });

          this.tweetSubscription = mySocket.tweetStream.subscribe((tweet) => {
            this.showTweet(tweet, false);
          });

          this.statusSubscription = mySocket.statusStream.subscribe((status) => {
            this.training = status.training;
            this.statusMessage = status.message;
          });
        },

        train: function() {
          mySocket.sendCommand("train");
        },

        _hidden: function(e) {
          let tweetElementId = "#tweet" + e.detail.tweetId;
          let hiddenTweet = this.$$(tweetElementId);
          console.log('hidden, ready to remove', tweetElementId, hiddenTweet);
        },

        _loaded: function(e) {
          console.log("loaded", e.detail)
        },

        _changeApiMode: function(newMode) {
          mySocket.sendCommand("apiMode", newMode);
        }
      });
    })();
  </script>
</dom-module>